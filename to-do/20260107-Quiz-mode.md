# Quiz Mode - Feature Documentation

**Date**: January 7, 2026  
**Status**: Planning Phase  
**Priority**: High

---

## üìã Overview

Quiz Mode is the 3rd mode (alongside Sheet and Board) that provides an interactive, gamified learning experience for testing kanji knowledge. Users can customize quiz parameters and receive immediate feedback with score tracking.

---

## üéØ Feature Goals

- **Primary**: Test kanji recognition and recall through multiple-choice questions
- **Secondary**: Track progress and performance over time
- **Tertiary**: Provide engaging, game-like experience with animations and feedback

---

## ‚öôÔ∏è Settings & Configuration

### Quiz Parameters

| Setting | Options | Default | Storage |
|---------|---------|---------|---------|
| **Number of Questions** | 10, 20 | 10 | localStorage |
| **Level Selection** | See below | Beginner | localStorage |
| **Max Time per Question** | 5s, 10s, 30s | 10s | localStorage |
| **Question Types** | See below | All enabled | localStorage |
| **Question Order** | Round Robin, Random | Round Robin | localStorage |

### Level Selection (Tab-based UI)

**Tab 1: Difficulty Levels**
- Beginner (N5/N4)
- Intermediate (N3)
- Advanced (N2/N1)

**Tab 2: JLPT Levels**
- N5
- N4
- N3
- N2
- N1

### Question Types (Checkboxes)
- ‚òë Kanji ‚Üí Han-Viet options
- ‚òë Han-Viet ‚Üí Kanji options
- ‚òë Kanji ‚Üí Vietnamese Meaning options

**Additional Option:**
- ‚òë Round Robin sequence (vs Random)

---

## üé¥ Core Components & Terminology

### QUIZ-CARD
Container component displaying:
- COUNTDOWN-NUMBER (top)
- QUESTION-ITEM (center, 50% of card size)
- ANSWER-OPTIONS (4 options with A/B/C/D labels)
- RESULT-STATUS (only visible during review)

### QUESTION-ITEM
- Can be: kanji text OR han-viet text
- Font size: 50% of QUIZ-CARD dimensions
- Position: Centered
- Multi-line if text overflows

### COUNTDOWN-NUMBER
- **Initial value**: Based on settings (5s, 10s, or 30s)
- **Behavior**: Counts down every second
- **Visual style**: 
  - Circular progress ring
  - Color gradient: Green (100%) ‚Üí Yellow (50%) ‚Üí Red (20%)
  - Pulsing animation when < 3 seconds
- **On timeout**: Show correct answer, mark as incorrect, auto-advance

### ANSWER-OPTIONS
- **Count**: Always 4 options (A, B, C, D)
- **Format**: Large letter badge + text content
- **Keyboard support**: Keys A, B, C, D
- **Visual feedback**: Highlight on click/select
- **Generation logic**:

#### When QUESTION-ITEM is Kanji:
**Type 1**: Random Han-Viet values (if hanViet not empty)
**Type 2**: Random Vietnamese Meanings (if vietnameseMeaning not empty)
**Type 3**: Random Onyomi readings (if onyomi not empty)

#### When QUESTION-ITEM is Han-Viet:
**Only Type**: Show correct kanji + 3 wrong kanjis

#### Wrong Answer Selection Priority:
1. Use `lookalike` field from database
2. Kanjis with same radical
3. Kanjis with same onyomi
4. Kanjis with similar han-viet
5. **Fallback**: Random kanji from same category

### USER-ANSWER
The option user selected before timeout or clicking "Next"

### CORRECT-ANSWER
The accurate answer, highlighted after user submission

### RESULT-STATUS
- **Visibility**: Only during review mode
- **Display**: 
  - ‚úÖ Green circle (correct)
  - ‚ùå Red cross (incorrect)
- **Position**: Top-left of QUIZ-CARD

### FINAL-POINT
- **Calculation**: `(correctAnswers / totalQuestions) * 10`
- **Range**: 0.0 to 10.0
- **Display**: X/Y correct, percentage, score out of 10

---

## üé® UI/UX Specifications

### Desktop Layout (‚â•768px)
- **3-Panel Grid**: Maintained (same as Sheet/Board)
- **Input Panel**: Show live progress stats
  - Current Question: X/Y
  - Score: X/Y (X correct out of Y attempted)
  - Accuracy: XX%
  - Average Time: Xs
- **Main Panel**: Quiz card with A4-paper container
- **Control Panel**: Blank or future enhancements

### Mobile Layout (<768px)
- **Full Screen**: Quiz takes entire viewport
- **Hamburger Menu**: Settings access
- **Swipe Gestures**:
  - **During Quiz**: Swipe left = Next (only forward)
  - **During Review**: Swipe left/right = Navigate both directions
- **Tinder-style**: Card slide animation

### Settings Modal (Desktop & Mobile)
- **Trigger**: Initial load or hamburger icon
- **Content**: All quiz configuration options
- **Action Buttons**:
  - "Start Quiz" (primary, disabled until valid config)
  - "Cancel" (return to previous mode)

### Quiz Interruption Handling
If user closes browser or switches modes mid-quiz:
- Save state to localStorage:
  - Current question index
  - Answers given so far
  - Time elapsed per question
  - Timestamp
- On return, show modal:
  - "Continue Quiz" (resume from saved state)
  - "Start New Quiz" (discard saved state)

---

## üé¨ Animations & Transitions

### Card Transitions

**Desktop (Option A - 3D Flip)**
```css
/* Card flips 180deg on Y-axis */
transform: rotateY(180deg);
transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
```

**Mobile (Option B - Slide)**
```css
/* Card slides left/right like Tinder */
transform: translateX(-100%);
transition: transform 0.4s ease-out;
```

### Answer Feedback Animation
1. User clicks option ‚Üí Highlight selected
2. User clicks "Next" ‚Üí Brief pause (200ms)
3. Show correct answer with green highlight
4. If wrong, show user's answer with red highlight
5. Wait 1.5s before transitioning to next card

### Countdown Animation
- Smooth rotation of circular progress ring
- Color interpolation based on remaining time
- Pulse effect (scale 1.0 ‚Üí 1.1 ‚Üí 1.0) when ‚â§ 3s

---

## üíæ Data Flow & State Management

### Redux State Structure

```typescript
// features/quiz/quizSlice.ts
interface QuizState {
  // Settings
  settings: {
    numberOfQuestions: 10 | 20;
    levelType: 'difficulty' | 'jlpt';
    selectedLevel: string; // 'beginner' | 'n5' | etc.
    maxTimePerQuestion: 5 | 10 | 30;
    questionTypes: {
      kanjiToHanViet: boolean;
      hanVietToKanji: boolean;
      kanjiToMeaning: boolean;
    };
    questionOrder: 'roundRobin' | 'random';
  };
  
  // Active Quiz
  active: {
    questions: QuizQuestion[];
    currentIndex: number;
    answers: UserAnswer[];
    startTime: number;
    paused: boolean;
  } | null;
  
  // History
  history: QuizResult[];
  
  // UI State
  showSettings: boolean;
  reviewMode: boolean;
}

interface QuizQuestion {
  id: string;
  type: 'kanjiToHanViet' | 'hanVietToKanji' | 'kanjiToMeaning';
  questionText: string; // The kanji or han-viet
  questionKanji: Kanji; // Reference to full kanji object
  options: string[]; // 4 options (A, B, C, D)
  correctIndex: number; // 0-3
}

interface UserAnswer {
  questionId: string;
  selectedIndex: number | null; // null = timeout
  timeSpent: number; // milliseconds
  correct: boolean;
}

interface QuizResult {
  id: string;
  timestamp: number;
  settings: QuizSettings;
  questions: QuizQuestion[];
  answers: UserAnswer[];
  score: number; // 0-10
  percentage: number; // 0-100
}
```

### LocalStorage Keys
- `quiz-settings`: Last used configuration
- `quiz-active`: Current in-progress quiz (auto-resume)
- `quiz-history`: Array of completed quizzes

---

## üîÑ Implementation Phases

### Phase 1: Core Features (MVP)

#### Step 1: Setup & Structure
- [ ] Create `features/quiz/quizSlice.ts`
- [ ] Create `features/quiz/Quiz.tsx` (main container)
- [ ] Create `features/quiz/QuizSettings.tsx` (modal)
- [ ] Create `features/quiz/QuizCard.tsx` (card component)
- [ ] Create `features/quiz/QuizReview.tsx` (results view)
- [ ] Create `public/locales/en/quiz.json`
- [ ] Create `public/locales/vi/quiz.json`
- [ ] Add 'quiz' to `worksheet.currentMode` type

#### Step 2: Settings UI
- [ ] Level selection tabs (Difficulty vs JLPT)
- [ ] Question count radio buttons
- [ ] Time limit radio buttons
- [ ] Question type checkboxes
- [ ] Round robin vs random toggle
- [ ] "Start Quiz" button with validation
- [ ] Remember settings in localStorage

#### Step 3: Question Generation
- [ ] Filter kanjis by selected level
- [ ] Generate questions based on enabled types
- [ ] Implement round-robin rotation logic
- [ ] Implement wrong answer selection algorithm:
  - Lookalike field
  - Same radical
  - Same onyomi
  - Similar han-viet
  - Random from category
- [ ] Ensure no duplicate questions
- [ ] Validate sufficient kanji pool

#### Step 4: Quiz Card UI
- [ ] Countdown timer with circular progress
- [ ] Question display (centered, responsive)
- [ ] 4 answer options with A/B/C/D labels
- [ ] Keyboard shortcuts (A, B, C, D keys)
- [ ] Highlight selected option
- [ ] "Next" button (gray when no selection)
- [ ] Disable options after selection
- [ ] Show correct answer on submit
- [ ] Timeout handling

#### Step 5: Progress Tracking
- [ ] Display live stats in Input Panel (desktop)
- [ ] Update stats after each answer
- [ ] Calculate final score
- [ ] Save to quiz history
- [ ] Auto-resume functionality

#### Step 6: Review Mode
- [ ] Grid overview of all questions
- [ ] Click to view detail
- [ ] Prev/Next navigation
- [ ] Show correct vs user answers
- [ ] Result status indicators
- [ ] Summary stats display
- [ ] "Retake Same", "New Quiz", "Back Home" buttons

#### Step 7: Mobile Optimizations
- [ ] Hamburger menu for settings
- [ ] Full-screen quiz layout
- [ ] Swipe gestures (next-only during quiz)
- [ ] Swipe gestures (bidirectional in review)
- [ ] Tinder-style slide animation

#### Step 8: Animations
- [ ] 3D flip (desktop) / Slide (mobile) transitions
- [ ] Countdown pulse effect
- [ ] Color gradient on progress ring
- [ ] Answer feedback animation
- [ ] Smooth card entry/exit

#### Step 9: Testing
- [ ] Unit tests for question generation
- [ ] Unit tests for answer validation
- [ ] Component tests for QuizCard
- [ ] E2E tests for full quiz flow
- [ ] Responsive tests (all breakpoints)
- [ ] Cross-browser testing
- [ ] Mobile device testing

### Phase 2: Enhancements (Future)

#### Advanced Scoring
- [ ] Time-based bonus: Faster answers = higher score
  - Formula: `baseScore + (remainingTime / maxTime) * bonusMultiplier`
- [ ] Streak bonus: Consecutive correct answers
  - 3+ correct: 1.2x multiplier
  - 5+ correct: 1.5x multiplier
  - 10+ correct: 2.0x multiplier
- [ ] Difficulty multiplier: Harder levels = more points
  - Beginner: 1.0x
  - Intermediate: 1.5x
  - Advanced: 2.0x

#### Stroke Pattern Similarity
- [ ] Research/integrate `kanji-similarity` library
- [ ] Or implement custom algorithm using KanjiVG data
- [ ] Add to wrong answer selection priority

#### Cloud Sync (Supabase)
- [ ] User authentication
- [ ] Cloud storage for quiz history
- [ ] Leaderboards
- [ ] Global statistics
- [ ] Cross-device sync

#### Additional Features
- [ ] Hints system (costs points)
- [ ] Daily challenges
- [ ] Achievement badges
- [ ] Study mode (no timer, explanations)
- [ ] Multiplayer quiz battles

---

## üß™ Testing Strategy

### Unit Tests
- Question generation logic
- Wrong answer selection algorithm
- Score calculation
- Timer countdown logic
- State persistence (localStorage)

### Component Tests
- QuizSettings validation
- QuizCard user interactions
- Answer selection and feedback
- Review navigation
- Keyboard shortcuts

### Integration Tests
- Full quiz flow (start ‚Üí answer ‚Üí review ‚Üí retake)
- Mode switching (Sheet ‚Üí Quiz ‚Üí Board)
- Settings persistence
- Auto-resume functionality

### E2E Tests (Playwright)
**Viewport Configurations:**
- PC Horizontal (1920x1080)
- PC Vertical (1080x1920)
- Tablet Horizontal (1024x768)
- Tablet Vertical (768x1024)
- Mobile Horizontal (844x390)
- Mobile Vertical (390x844)

**Test Scenarios:**
1. Complete quiz with all correct answers
2. Complete quiz with timeout on some questions
3. Complete quiz with mix of correct/incorrect
4. Interrupt quiz and resume
5. Interrupt quiz and start new
6. Review mode navigation (all directions)
7. Settings validation (invalid configs)
8. Mobile swipe gestures
9. Keyboard shortcuts
10. Level switching and question pool validation

---

## üìù i18n Keys Structure

### `public/locales/en/quiz.json`

```json
{
  "mode_name": "Quiz Mode",
  "settings": {
    "title": "Quiz Settings",
    "number_of_questions": "Number of Questions",
    "level_selection": "Level Selection",
    "difficulty_tab": "Difficulty",
    "jlpt_tab": "JLPT Levels",
    "beginner": "Beginner (N5/N4)",
    "intermediate": "Intermediate (N3)",
    "advanced": "Advanced (N2/N1)",
    "max_time": "Max Time per Question",
    "question_types": "Question Types",
    "kanji_to_hanviet": "Kanji ‚Üí Han-Viet",
    "hanviet_to_kanji": "Han-Viet ‚Üí Kanji",
    "kanji_to_meaning": "Kanji ‚Üí Meaning",
    "question_order": "Question Order",
    "round_robin": "Round Robin",
    "random": "Random",
    "start_quiz": "Start Quiz",
    "cancel": "Cancel"
  },
  "quiz": {
    "question": "Question",
    "of": "of",
    "next": "Next",
    "timeout": "Time's up!",
    "correct": "Correct!",
    "incorrect": "Incorrect",
    "your_answer": "Your Answer",
    "correct_answer": "Correct Answer"
  },
  "progress": {
    "current_question": "Current Question",
    "score": "Score",
    "accuracy": "Accuracy",
    "average_time": "Avg Time"
  },
  "review": {
    "title": "Quiz Results",
    "summary": "Summary",
    "score": "Score",
    "percentage": "Percentage",
    "correct": "Correct",
    "questions_label": "Questions",
    "review_answers": "Review Answers",
    "retake_same": "Retake Same Quiz",
    "new_quiz": "New Quiz",
    "back_home": "Back to Settings",
    "previous": "Previous",
    "next": "Next"
  },
  "interruption": {
    "title": "Quiz In Progress",
    "message": "You have an unfinished quiz. Would you like to continue?",
    "continue": "Continue Quiz",
    "start_new": "Start New Quiz"
  },
  "errors": {
    "insufficient_kanjis": "Not enough kanjis available for selected level and question count",
    "no_question_types": "Please select at least one question type",
    "generation_failed": "Failed to generate quiz questions"
  }
}
```

### `public/locales/vi/quiz.json`
(Mirror structure with Vietnamese translations)

---

## üö® Edge Cases & Error Handling

### Insufficient Kanji Pool
**Scenario**: User selects 20 questions but N5 has only 15 kanjis
**Solution**: 
1. Detect pool size before generation
2. Show error modal: "Not enough kanjis available. Please reduce question count or select broader level."
3. Disable "Start Quiz" button

### Empty Required Fields
**Scenario**: Selected kanji has empty `hanViet`, `vietnameseMeaning`, or `onyomi`
**Solution**: Skip that kanji during question generation, select next eligible kanji

### Failed Wrong Answer Generation
**Scenario**: Cannot find 3 wrong answers even after all fallback methods
**Solution**: 
1. Log warning
2. Use random kanjis from entire database as last resort
3. Ensure uniqueness (no duplicates in 4 options)

### Timer Drift
**Scenario**: JavaScript timer can be inaccurate due to browser throttling
**Solution**: 
1. Use `Date.now()` to track actual elapsed time
2. Calculate remaining time on each tick
3. Ensure countdown never goes negative

### Rapid Button Clicks
**Scenario**: User clicks "Next" multiple times rapidly
**Solution**: Disable button immediately after first click, re-enable on next question

### Browser Refresh During Quiz
**Scenario**: User accidentally refreshes page mid-quiz
**Solution**: 
1. Auto-save state every answer
2. Show "Continue Quiz" modal on reload
3. Preserve countdown state (don't restart timer)

---

## üìê Component Hierarchy

```
App
‚îî‚îÄ‚îÄ MainView (mode === 'quiz')
    ‚îú‚îÄ‚îÄ InputPanel (desktop only)
    ‚îÇ   ‚îî‚îÄ‚îÄ QuizProgressStats
    ‚îú‚îÄ‚îÄ MainPanel
    ‚îÇ   ‚îî‚îÄ‚îÄ Quiz
    ‚îÇ       ‚îú‚îÄ‚îÄ QuizSettings (modal, initial)
    ‚îÇ       ‚îú‚îÄ‚îÄ QuizCard (active quiz)
    ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ CountdownTimer
    ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ QuestionDisplay
    ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ AnswerOptions
    ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ NextButton
    ‚îÇ       ‚îî‚îÄ‚îÄ QuizReview (after completion)
    ‚îÇ           ‚îú‚îÄ‚îÄ ReviewSummary
    ‚îÇ           ‚îú‚îÄ‚îÄ ReviewGrid
    ‚îÇ           ‚îî‚îÄ‚îÄ ReviewActions
    ‚îî‚îÄ‚îÄ ControlPanel (blank or future use)
```

---

## üé® Visual Design Guidelines

### Color Palette
- **Primary**: Blue (#3B82F6) - Quiz branding
- **Success**: Green (#10B981) - Correct answers
- **Error**: Red (#EF4444) - Incorrect answers
- **Warning**: Yellow (#F59E0B) - Low time warning
- **Neutral**: Gray shades (#1F2937, #374151, #6B7280)

### Typography
- **Question Text**: 
  - Desktop: 3-4rem (48-64px)
  - Mobile: 2.5-3rem (40-48px)
  - Font: Same as main panel kanji font (from settings)
- **Answer Options**: 
  - Desktop: 1.5rem (24px)
  - Mobile: 1.25rem (20px)
- **Countdown**: 
  - Desktop: 3rem (48px)
  - Mobile: 2.5rem (40px)
  - Font: Monospace, bold

### Spacing
- Card padding: 2rem (32px)
- Option gap: 1rem (16px)
- Button margin: 1.5rem (24px)

---

## üîó Related Files & Dependencies

### New Files to Create
- `src/features/quiz/quizSlice.ts`
- `src/features/quiz/Quiz.tsx`
- `src/features/quiz/QuizSettings.tsx`
- `src/features/quiz/QuizCard.tsx`
- `src/features/quiz/QuizReview.tsx`
- `src/features/quiz/CountdownTimer.tsx`
- `src/features/quiz/AnswerOptions.tsx`
- `src/features/quiz/QuizProgressStats.tsx`
- `src/features/quiz/utils/questionGenerator.ts`
- `src/features/quiz/utils/answerValidator.ts`
- `src/features/quiz/utils/scoreCalculator.ts`
- `public/locales/en/quiz.json`
- `public/locales/vi/quiz.json`

### Files to Modify
- `src/features/worksheet/worksheetSlice.ts` - Add 'quiz' to mode type
- `src/features/mainView/MainView.tsx` - Add Quiz mode render
- `src/features/controlPanel/ControlPanel.tsx` - Add Quiz mode button
- `src/App.tsx` - Update mobile tab switcher (if needed)
- `src/i18n/config.ts` - Add 'quiz' namespace

---

## ‚úÖ Definition of Done

Phase 1 is complete when:
- [ ] All Phase 1 checklist items are implemented
- [ ] Unit test coverage ‚â•80%
- [ ] All E2E tests pass on all viewport configurations
- [ ] No console errors or warnings
- [ ] Quiz can be started, completed, and reviewed
- [ ] Settings persist across sessions
- [ ] Auto-resume works correctly
- [ ] Mobile swipe gestures work
- [ ] All animations are smooth (60fps)
- [ ] i18n works for both English and Vietnamese
- [ ] Code passes ESLint checks
- [ ] Documentation is updated

---

## üìö Additional Resources

### Libraries to Consider
- `react-spring` - Advanced animations
- `framer-motion` - Gesture-based animations
- `react-countdown-circle-timer` - Circular countdown component
- `zustand` (alternative) - If Redux becomes too complex

### Reference Implementations
- Duolingo quiz UI patterns
- Anki flashcard animations
- Tinder swipe mechanics
- Google Forms quiz mode

---

**End of Document**
