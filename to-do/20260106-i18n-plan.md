# Internationalization (i18n) Implementation Plan

**Date**: January 6, 2026  
**Status**: Planning  
**Estimated Time**: 4-6 hours  
**Approach**: react-i18next with separate language files

---

## üìã Requirements Summary

### **Configuration Decisions**
- **URL Strategy**: Query parameter approach `/sheet?lang=vi` (not path-based `/vi/sheet`)
- **Default Language**: Vietnamese (vi)
- **Supported Languages**: Vietnamese (vi), English (en), expandable to French (fr) and others
- **Language Persistence**: localStorage (survives page refresh)
- **Translation Scope**: UI + help/documentation
- **Migration Strategy**: Gradual rollout (safer, lower risk)

### **Language Switcher**
- **Location**: Floating Action Button (FAB) menu
- **Behavior**: Updates URL query param, persists to localStorage

### **Translation Editor (Dev-Only)**
- **Access Methods**: 
  - URL: `http://localhost:5173/dev/translations`
  - Keyboard Shortcut: `Ctrl+Shift+T` (or `Cmd+Shift+T` on Mac)
- **Safety**: Completely removed from production build via `import.meta.env.DEV`
- **Features**:
  - ‚úÖ View all translations side-by-side
  - ‚úÖ Edit inline (saves to JSON files)
  - ‚úÖ Highlight missing translations
  - ‚úÖ Search/filter keys
  - ‚ö†Ô∏è Export to Excel (future)
  - ‚ö†Ô∏è Import from Excel (future)

---

## üèóÔ∏è File Structure

```
public/
  locales/
    vi/
      common.json          # Shared: buttons, labels, modes
      sheet.json           # Sheet mode specific
      board.json           # Board mode specific
      controls.json        # Control panel settings
      messages.json        # Toasts, errors, success messages
      export.json          # Export progress messages
    en/
      common.json
      sheet.json
      board.json
      controls.json
      messages.json
      export.json

src/
  i18n/
    config.ts            # i18next configuration
    types.ts             # TypeScript types for translation keys
  components/
    LanguageSwitcher.tsx # Dropdown/FAB menu item
  dev/
    TranslationEditor.tsx # Dev-only translation helper UI
```

---

## üì¶ Phase 1: i18n Foundation Setup (1-2 hours)

### **1.1 Install Dependencies**
```bash
npm install i18next react-i18next i18next-browser-languagedetector i18next-http-backend
```

**Packages:**
- `i18next` - Core i18n engine
- `react-i18next` - React bindings
- `i18next-browser-languagedetector` - Auto-detect language from URL/localStorage
- `i18next-http-backend` - Lazy load translation files

### **1.2 Create i18n Configuration**

**File: `src/i18n/config.ts`**
```typescript
import i18n from 'i18next';
import { initReactI18next } from 'react-i18next';
import LanguageDetector from 'i18next-browser-languagedetector';
import Backend from 'i18next-http-backend';

i18n
  .use(Backend) // Lazy load translations
  .use(LanguageDetector) // Detect user language
  .use(initReactI18next)
  .init({
    fallbackLng: 'vi', // Default: Vietnamese
    supportedLngs: ['vi', 'en'],
    defaultNS: 'common',
    ns: ['common', 'sheet', 'board', 'controls', 'messages', 'export'],
    
    detection: {
      order: ['querystring', 'localStorage', 'navigator'],
      lookupQuerystring: 'lang', // Read from ?lang=vi
      caches: ['localStorage'], // Persist to localStorage
    },
    
    backend: {
      loadPath: '/locales/{{lng}}/{{ns}}.json',
    },
    
    interpolation: {
      escapeValue: false, // React already escapes
    },
  });

export default i18n;
```

### **1.3 Create Initial Translation Files**

**File: `public/locales/vi/common.json`**
```json
{
  "app": {
    "title": "T·∫°o B·∫£ng Luy·ªán T·∫≠p Kanji",
    "tagline": "Luy·ªán t·∫≠p ch·ªØ Kanji v·ªõi b·∫£ng t√πy ch·ªânh"
  },
  "modes": {
    "sheet": "Ch·∫ø ƒê·ªô Sheet",
    "board": "Ch·∫ø ƒê·ªô Board"
  },
  "buttons": {
    "export_pdf": "Xu·∫•t PDF",
    "export_png": "Xu·∫•t PNG",
    "clear_all": "X√≥a T·∫•t C·∫£",
    "reload_data": "T·∫£i L·∫°i D·ªØ Li·ªáu"
  }
}
```

**File: `public/locales/en/common.json`**
```json
{
  "app": {
    "title": "Kanji Worksheet Generator",
    "tagline": "Practice Japanese kanji with customizable worksheets"
  },
  "modes": {
    "sheet": "Sheet Mode",
    "board": "Board Mode"
  },
  "buttons": {
    "export_pdf": "Export PDF",
    "export_png": "Export PNG",
    "clear_all": "Clear All",
    "reload_data": "Reload Data"
  }
}
```

### **1.4 Initialize i18n in App**

**File: `src/main.tsx`**
```typescript
import './i18n/config'; // Import BEFORE React renders

ReactDOM.createRoot(document.getElementById('root')!).render(
  <React.StrictMode>
    <Provider store={store}>
      <BrowserRouter>
        <App />
      </BrowserRouter>
    </Provider>
  </React.StrictMode>
);
```

### **1.5 Add TypeScript Types**

**File: `src/i18n/types.ts`**
```typescript
import 'react-i18next';
import common from '../../public/locales/vi/common.json';

declare module 'react-i18next' {
  interface CustomTypeOptions {
    defaultNS: 'common';
    resources: {
      common: typeof common;
    };
  }
}
```

**Benefits:**
- Auto-completion: `t('app.title')` suggests keys
- Type errors: `t('app.titl')` shows TypeScript error

---

## üîß Phase 2: Language Switching Integration (1 hour)

### **2.1 Create Language Switcher Component**

**File: `src/components/LanguageSwitcher.tsx`**
```typescript
import { useTranslation } from 'react-i18next';
import { useSearchParams } from 'react-router-dom';

export const LanguageSwitcher = () => {
  const { i18n } = useTranslation();
  const [searchParams, setSearchParams] = useSearchParams();
  
  const changeLanguage = (lang: string) => {
    i18n.changeLanguage(lang);
    setSearchParams({ lang }); // Update URL: /sheet?lang=vi
  };
  
  return (
    <select 
      value={i18n.language} 
      onChange={(e) => changeLanguage(e.target.value)}
      className="bg-gray-700 text-white px-2 py-1 rounded"
    >
      <option value="vi">üáªüá≥ Ti·∫øng Vi·ªát</option>
      <option value="en">üá∫üá∏ English</option>
    </select>
  );
};
```

### **2.2 Integrate with FAB (Future)**

When FAB is implemented, add language switcher to its menu:

```typescript
// In FAB menu items
const fabMenuItems = [
  { icon: 'üìÑ', label: 'Sheet Mode', path: '/sheet' },
  { icon: 'üìã', label: 'Board Mode', path: '/board' },
  { divider: true },
  { component: <LanguageSwitcher /> }, // ‚Üê Add here
];
```

### **2.3 Temporary: Add to App Header**

Until FAB is ready, add to top-right corner:

```typescript
// src/App.tsx
<div className="fixed top-4 right-4 z-50">
  <LanguageSwitcher />
</div>
```

---

## üé® Phase 3: Translation Editor (Dev-Only) (2-3 hours)

### **3.1 Create Translation Editor Component**

**File: `src/dev/TranslationEditor.tsx`**

**Features:**
- Side-by-side view of all languages
- Inline editing with auto-save
- Highlight missing keys (red background)
- Search/filter functionality
- Stats: total keys, missing translations, completion %

**Structure:**
```typescript
import { useState, useEffect } from 'react';

interface TranslationData {
  [key: string]: {
    vi: string;
    en: string;
  };
}

export const TranslationEditor = ({ onClose }: { onClose?: () => void }) => {
  const [data, setData] = useState<TranslationData>({});
  const [searchTerm, setSearchTerm] = useState('');
  const [namespace, setNamespace] = useState('common');
  
  // Load translation files
  useEffect(() => {
    const loadTranslations = async () => {
      const vi = await fetch(`/locales/vi/${namespace}.json`).then(r => r.json());
      const en = await fetch(`/locales/en/${namespace}.json`).then(r => r.json());
      // Merge into side-by-side format
      setData(mergeTranslations(vi, en));
    };
    loadTranslations();
  }, [namespace]);
  
  const saveTranslation = async (key: string, lang: string, value: string) => {
    // In dev mode, can save via fetch to dev server endpoint
    // Or use localStorage for temporary edits
    // Real saves require backend API or manual JSON editing
  };
  
  return (
    <div className="fixed inset-0 bg-white z-[9999] overflow-auto">
      {/* Header */}
      <div className="sticky top-0 bg-gray-800 text-white p-4 flex justify-between items-center">
        <h1 className="text-2xl font-bold">Translation Editor (Dev Mode)</h1>
        <div className="flex gap-4 items-center">
          <input
            type="text"
            placeholder="Search keys..."
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
            className="px-3 py-1 rounded text-black"
          />
          <select
            value={namespace}
            onChange={(e) => setNamespace(e.target.value)}
            className="px-3 py-1 rounded text-black"
          >
            <option value="common">Common</option>
            <option value="sheet">Sheet</option>
            <option value="board">Board</option>
            <option value="controls">Controls</option>
            <option value="messages">Messages</option>
          </select>
          <button onClick={onClose} className="px-4 py-2 bg-red-600 rounded">
            Close (Esc)
          </button>
        </div>
      </div>
      
      {/* Stats Bar */}
      <div className="bg-gray-100 p-3 flex gap-6">
        <span>Total Keys: {Object.keys(data).length}</span>
        <span className="text-red-600">
          Missing VI: {countMissing(data, 'vi')}
        </span>
        <span className="text-red-600">
          Missing EN: {countMissing(data, 'en')}
        </span>
        <span className="text-green-600">
          Completion: {calculateCompletion(data)}%
        </span>
      </div>
      
      {/* Table */}
      <table className="w-full">
        <thead className="bg-gray-200 sticky top-16">
          <tr>
            <th className="w-1/4 p-2 text-left">Key</th>
            <th className="w-3/8 p-2 text-left">Vietnamese (vi)</th>
            <th className="w-3/8 p-2 text-left">English (en)</th>
          </tr>
        </thead>
        <tbody>
          {Object.entries(data)
            .filter(([key]) => key.toLowerCase().includes(searchTerm.toLowerCase()))
            .map(([key, translations]) => (
              <tr key={key} className="border-b hover:bg-gray-50">
                <td className="p-2 font-mono text-sm text-gray-600">{key}</td>
                <td className={`p-2 ${!translations.vi ? 'bg-red-50' : ''}`}>
                  <input
                    type="text"
                    value={translations.vi || ''}
                    onChange={(e) => updateTranslation(key, 'vi', e.target.value)}
                    className="w-full px-2 py-1 border rounded"
                    placeholder="Missing translation"
                  />
                </td>
                <td className={`p-2 ${!translations.en ? 'bg-red-50' : ''}`}>
                  <input
                    type="text"
                    value={translations.en || ''}
                    onChange={(e) => updateTranslation(key, 'en', e.target.value)}
                    className="w-full px-2 py-1 border rounded"
                    placeholder="Missing translation"
                  />
                </td>
              </tr>
            ))}
        </tbody>
      </table>
    </div>
  );
};
```

### **3.2 Integrate with App (Dev Mode Only)**

**File: `src/App.tsx`**
```typescript
import { lazy, Suspense, useState, useEffect } from 'react';

// Lazy load - not included in production bundle
const TranslationEditor = lazy(() => 
  import.meta.env.DEV 
    ? import('./dev/TranslationEditor')
    : Promise.resolve({ default: () => null })
);

export const App = () => {
  const [showDevTools, setShowDevTools] = useState(false);
  
  // Keyboard shortcut: Ctrl+Shift+T
  useEffect(() => {
    if (!import.meta.env.DEV) return;
    
    const handleKeyPress = (e: KeyboardEvent) => {
      if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'T') {
        e.preventDefault();
        setShowDevTools(prev => !prev);
      }
    };
    
    window.addEventListener('keydown', handleKeyPress);
    return () => window.removeEventListener('keydown', handleKeyPress);
  }, []);
  
  return (
    <>
      {/* Normal app routes */}
      <Routes>
        <Route path="/sheet" element={<SheetMode />} />
        <Route path="/board" element={<BoardMode />} />
        
        {/* Dev-only route */}
        {import.meta.env.DEV && (
          <Route path="/dev/translations" element={
            <Suspense fallback={<div>Loading...</div>}>
              <TranslationEditor />
            </Suspense>
          } />
        )}
      </Routes>
      
      {/* Keyboard shortcut overlay */}
      {showDevTools && (
        <Suspense fallback={<div>Loading dev tools...</div>}>
          <TranslationEditor onClose={() => setShowDevTools(false)} />
        </Suspense>
      )}
    </>
  );
};
```

### **3.3 Add ESC Key to Close**

```typescript
// Inside TranslationEditor
useEffect(() => {
  const handleEsc = (e: KeyboardEvent) => {
    if (e.key === 'Escape' && onClose) {
      onClose();
    }
  };
  window.addEventListener('keydown', handleEsc);
  return () => window.removeEventListener('keydown', handleEsc);
}, [onClose]);
```

---

## üîÑ Phase 4: Gradual Component Migration (Ongoing)

### **Week 1: High-Priority Components**

**4.1 Control Panel**
- Export buttons (PDF/PNG)
- Mode switcher buttons
- Settings labels

```typescript
// Before:
<button>Export PDF</button>

// After:
import { useTranslation } from 'react-i18next';
const { t } = useTranslation('common');
<button>{t('buttons.export_pdf')}</button>
```

**4.2 Input Panel**
- Search placeholder
- Section titles
- "No kanjis selected" message

**4.3 Main View**
- Empty state messages
- Loading text

### **Week 2: Medium-Priority**

**4.4 Messages & Notifications**
- Export progress messages
- Success/error toasts
- Validation warnings

**4.5 Tooltips & Help Text**
- Button tooltips
- Setting descriptions
- Keyboard shortcuts

### **Week 3: Low-Priority**

**4.6 About/Footer**
- Footer text
- About page content
- Credits

---

## üìù Translation Key Naming Convention

### **Structure**
```
namespace.category.item
```

### **Examples**
```json
{
  "buttons": {
    "export_pdf": "Export PDF",
    "export_png": "Export PNG"
  },
  "messages": {
    "export": {
      "success": "Exported successfully!",
      "error": "Export failed: {{error}}"
    }
  },
  "validation": {
    "no_kanjis": "Please select at least one kanji"
  }
}
```

### **Usage with Interpolation**
```typescript
t('messages.export.error', { error: 'Network timeout' })
// ‚Üí "Export failed: Network timeout"
```

---

## ‚úÖ Validation & Quality Assurance

### **Pre-Commit Checks**
```bash
# Add to package.json scripts
"scripts": {
  "i18n:validate": "node scripts/validate-translations.js"
}

# Run before commit
git commit
  ‚Üí Runs i18n:validate
  ‚Üí Checks all languages have same keys
  ‚Üí Blocks commit if missing translations
```

### **Validation Script**

**File: `scripts/validate-translations.js`**
```javascript
const fs = require('fs');
const path = require('path');

const languages = ['vi', 'en'];
const namespaces = ['common', 'sheet', 'board', 'controls', 'messages'];

const getAllKeys = (obj, prefix = '') => {
  let keys = [];
  for (const [key, value] of Object.entries(obj)) {
    const fullKey = prefix ? `${prefix}.${key}` : key;
    if (typeof value === 'object' && !Array.isArray(value)) {
      keys = keys.concat(getAllKeys(value, fullKey));
    } else {
      keys.push(fullKey);
    }
  }
  return keys;
};

let hasErrors = false;

namespaces.forEach(ns => {
  console.log(`\nValidating ${ns}.json...`);
  
  const translations = {};
  languages.forEach(lang => {
    const filePath = path.join(__dirname, `../public/locales/${lang}/${ns}.json`);
    translations[lang] = JSON.parse(fs.readFileSync(filePath, 'utf8'));
  });
  
  const keysByLang = {};
  languages.forEach(lang => {
    keysByLang[lang] = getAllKeys(translations[lang]);
  });
  
  // Check for missing keys
  languages.forEach(lang => {
    const otherLangs = languages.filter(l => l !== lang);
    otherLangs.forEach(otherLang => {
      const missing = keysByLang[otherLang].filter(k => !keysByLang[lang].includes(k));
      if (missing.length > 0) {
        console.error(`‚ùå Missing in ${lang}:`, missing);
        hasErrors = true;
      }
    });
  });
  
  if (!hasErrors) {
    console.log(`‚úÖ ${ns}.json is valid`);
  }
});

if (hasErrors) {
  console.error('\n‚ùå Translation validation failed!');
  process.exit(1);
} else {
  console.log('\n‚úÖ All translations are valid!');
}
```

---

## üìä Testing Checklist

### **Manual Testing**

- [ ] Language switches via dropdown
- [ ] URL updates: `/sheet?lang=vi`
- [ ] localStorage persists language on refresh
- [ ] All translated strings display correctly
- [ ] Vietnamese is default language
- [ ] Keyboard shortcut `Ctrl+Shift+T` opens editor (dev only)
- [ ] Translation Editor shows all keys
- [ ] Missing translations highlighted in red
- [ ] Search/filter works
- [ ] Production build excludes Translation Editor
- [ ] Production bundle size is smaller
- [ ] Keyboard shortcut doesn't work in production

### **Automated Testing**

Add tests for:
```typescript
describe('i18n', () => {
  it('defaults to Vietnamese', () => {
    expect(i18n.language).toBe('vi');
  });
  
  it('switches language and updates URL', () => {
    changeLanguage('en');
    expect(window.location.search).toContain('lang=en');
  });
  
  it('persists language to localStorage', () => {
    changeLanguage('en');
    expect(localStorage.getItem('i18nextLng')).toBe('en');
  });
});
```

---

## üöÄ Deployment Checklist

- [ ] All translation files committed
- [ ] Validation script passes
- [ ] Build succeeds without errors
- [ ] Production bundle size acceptable
- [ ] Translation Editor not in production bundle
- [ ] Default language set to Vietnamese
- [ ] Language switcher visible in UI
- [ ] Documentation updated

---

## üìö Documentation Updates Needed

### **README.md**
- Add "Supported Languages" section
- Document language switching
- Link to translation contribution guide

### **New: CONTRIBUTING_TRANSLATIONS.md**
- How to add new languages
- Translation file structure
- Key naming conventions
- Using Translation Editor (dev mode)
- Validation process

---

## üîÆ Future Enhancements

### **Phase 5: Additional Features (Optional)**

1. **Export/Import Excel**
   - Generate Excel with columns: Key | VI | EN
   - Send to translator
   - Import back after translation

2. **More Languages**
   - French (fr)
   - Japanese (ja)
   - Chinese (zh)

3. **Translation Memory**
   - Track translation history
   - Revert to previous versions
   - Compare changes

4. **AI Translation Suggestions**
   - Use OpenAI/Google Translate API
   - Suggest translations for missing keys
   - Quality check existing translations

5. **Context Preview**
   - Show where each key is used in app
   - Click to navigate to component
   - Screenshot of usage location

---

## üìû Support & Questions

**During Implementation:**
- Translation Editor not opening? Check `import.meta.env.DEV` is true
- Keys not found? Check namespace is loaded: `t('common:buttons.export')`
- Language not switching? Check URL param and localStorage
- Missing translations? Run validation script

**After Deployment:**
- Users report wrong language? Check localStorage and URL
- New translations not showing? Clear browser cache
- Inconsistent translations? Run validation script

---

## ‚úÖ Success Metrics

**After Phase 1-3:**
- [ ] Language can be switched
- [ ] At least 20 core strings translated
- [ ] Translation Editor functional in dev mode
- [ ] Production build excludes dev tools

**After Full Migration:**
- [ ] 100% UI strings translated
- [ ] Zero validation errors
- [ ] Users can seamlessly switch languages
- [ ] Documentation complete

---

**End of Implementation Plan**
